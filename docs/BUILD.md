# SnapRecords Build Guide

This document outlines the build process for the **SnapRecords** project, a modern TypeScript-based data grid library built with Vite.

It covers installation, available scripts, and configuration options for building the library for production, including features like column resizing, drag-and-drop column reordering, multiple rendering modes (table, list, mobile cards), lazy loading of media, and enhanced accessibility support.

## Installation

To set up the project and install dependencies, run:

```bash
npm install
```

This installs all required dependencies, including `dexie` (for IndexedDB caching), `immer` (for immutable state management), `lru-cache` (for efficient format caching), and development tools like `vite`, `typescript`, `sass`, `jest`, and `vite-plugin-dts`.

## Available Scripts

The following scripts are defined in `package.json`:

### `npm run dev`

Starts the Vite development server with Hot Module Replacement (HMR) for rapid development. This is useful for testing changes to the library, including features like column resizing, drag-and-drop, and different rendering modes.

```bash
npm run dev
```

### `npm run build`

Compiles the library for production. This script runs:

1. `vite build` to bundle the library into the `dist/` folder, producing both ES Module (`snap-records.es.js`) and UMD (`snap-records.umd.js`) formats, along with type declarations and source maps.
2. `sass src/scss/SnapRecords.scss dist/snap-records.css --style=compressed --source-map` to compile SCSS styles into compressed CSS with source maps, supporting the library’s styling, including draggable columns and responsive mobile card layouts.

The output structure in `dist/` will look like:

```
dist/
├── index.d.ts
├── snap-records.css
├── snap-records.css.map
├── snap-records.es.js
├── snap-records.es.js.map
├── snap-records.umd.js
├── snap-records.umd.js.map
```

Run the build with:

```bash
npm run build
```

### `npm run build:js`

Compiles only the JavaScript/TypeScript portion of the library using Vite, producing `snap-records.es.js` and `snap-records.umd.js`.

```bash
npm run build:js
```

### `npm run build:css`

Compiles the SCSS styles (`src/scss/SnapRecords.scss`) into compressed CSS (`dist/snap-records.css`) with source maps, supporting the library’s styling for all rendering modes and features.

```bash
npm run build:css
```

### `npm run test`

Runs unit tests located in the `tests/` directory using Jest with JSDOM. The tests cover initialization, public API methods, user interactions (e.g., sorting, column resizing, drag-and-drop), and rendering modes (list and mobile cards). The `tests/setupTests.ts` file configures the testing environment with mocks for `fetch`, `window.matchMedia`, `DataTransfer`, and `DragEvent`.

```bash
npm run test
```

### `npm run preview`

Starts a local server to preview the contents of the `dist/` folder generated by the production build. This is useful for verifying the built assets, including the CSS styles for list and mobile card modes.

```bash
npm run preview
```

### `npm run lint`

Runs ESLint to check for code quality issues in `src/` files, ensuring consistency with the project’s coding standards.

```bash
npm run lint
```

### `npm run lint:fix`

Runs ESLint with automatic fixes for resolvable issues.

```bash
npm run lint:fix
```

### `npm run format`

Formats all source files (`js`, `ts`, `json`, `scss`, `md`) using Prettier to maintain consistent code style.

```bash
npm run format
```

### `npm run demo:dev`

Starts the Vite development server for the demo application, using the configuration in `vite.config.demo.ts`. This is useful for testing the library in a sample application.

```bash
npm run demo:dev
```

### `npm run demo:build`

Builds the demo application for production, using the configuration in `vite.config.demo.ts`, and outputs the assets to the `dist/` folder.

```bash
npm run demo:build
```

## Writing Tests

Unit tests are located in the `tests/` directory and use Jest with JSDOM. To add a new test:

1. Create a file in `tests/` (e.g., `MyFeature.test.ts`).
2. Use `@testing-library/dom` for DOM assertions.
3. Mock dependencies like `fetch`, `DataTransfer`, or `DragEvent` in `tests/setupTests.ts` if needed.

Example test for column resizing:

```typescript
import { SnapRecords } from '../src/SnapRecords';
import { fireEvent } from '@testing-library/dom';

test('resizes column', () => {
    document.body.innerHTML = '<div id="table-container"></div>';
    const snapRecords = new SnapRecords('table-container', {
        url: '/api/data',
        columns: ['id', 'name'],
    });
    const th = document.querySelector('th[data-col-id="id"]');
    const resizeHandle = th.querySelector('.snap-column-resize-handle');
    fireEvent.mouseDown(resizeHandle);
    fireEvent.mouseMove(document, { clientX: 200 });
    fireEvent.mouseUp(document);
    expect(snapRecords.state.columnWidths.get('id')).toBeGreaterThan(0);
});
```

## SnapRecords Features

The SnapRecords library includes several functionalities that enhance its flexibility and usability:

- **Flexible Theming System**: Styling is built on CSS Custom Properties (`--sr-...`). This architecture provides built-in `light` and `dark` themes, plus a `default` theme that seamlessly inherits styles from the host application, allowing for deep customization.
- **Column Resizing**: Users can resize table columns by dragging resize handles, with widths persisted in the state.
- **Column Drag-and-Drop**: Columns can be reordered via drag-and-drop when `draggableColumns` is enabled.
- **Multiple Rendering Modes**: Supports three rendering modes: `TABLE`, `LIST`, and `MOBILE_CARDS`.
- **Lazy Loading of Media**: Images in table cells are loaded lazily when `lazyLoadMedia` is enabled.
- **Enhanced Accessibility**: Includes ARIA attributes, keyboard navigation, and screen reader announcements.
- **Row Selection**: Users can select rows in selectable mode, with visual feedback and lifecycle hooks for selection changes.
- **Persistent State**: State can be persisted to `localStorage` when `persistState` is enabled.
- **Preloading Next Page**: When `preloadNextPage` is enabled, the next page’s data is pre-fetched.
- **Retry Mechanism**: Failed data fetches are retried up to a configurable number of attempts (`retryAttempts`).
- **Efficient Format Caching**: Uses `lru-cache` for managing formatted cell values, controlled by `formatCacheSize`.

These features are tested in `tests/SnapRecords.test.ts`, covering initialization, user interactions, and API methods.

## Build Configuration

The build process is configured through `vite.config.ts`, `package.json`, `tsconfig.json`, and `jest.config.js`. Below are the key configuration options and customization possibilities, updated to reflect all features and scripts.

### 1. Including or Excluding the `dexie`, `immer`, and `lru-cache` Dependencies

You can choose whether `dexie` (for IndexedDB caching), `immer` (for immutable state management), and `lru-cache` (for format caching) are bundled into the final output or treated as external dependencies.

**File Location**: `vite.config.ts`

#### Option A: Include `dexie`, `immer`, and `lru-cache` (Self-Contained File)

Bundles all libraries into the output files, creating a self-contained library with no external dependencies. This is ideal for direct browser use or projects without a bundler.

```typescript
// vite.config.ts
export default defineConfig({
    // ...
    build: {
        // ...
        rollupOptions: {}, // No external dependencies
        // ...
    },
});
```

#### Option B: Exclude `dexie`, `immer`, and `lru-cache` (Standard Library Mode)

Treats these libraries as external dependencies, expecting the host environment to provide them. This is recommended for npm distribution to avoid version conflicts and reduce bundle size in modern applications (e.g., React, Vue) that use tree-shaking.

```typescript
// vite.config.ts
export default defineConfig({
    // ...
    build: {
        // ...
        rollupOptions: {
            external: ['dexie', 'immer', 'lru-cache'],
            output: {
                globals: {
                    dexie: 'Dexie',
                    immer: 'immer',
                    'lru-cache': 'LRUCache',
                },
            },
        },
        // ...
    },
});
```

> **When to choose each option?**
>
> - **Include `dexie`, `immer`, `lru-cache`**: Use for standalone scripts in simple HTML files or environments without a module bundler.
> - **Exclude `dexie`, `immer`, `lru-cache`**: Use for npm packages consumed by modern applications, allowing the application’s bundler to manage these dependencies and optimize the final bundle size.

**Current Configuration**: The `vite.config.ts` does not specify `external: ['dexie', 'immer', 'lru-cache']`, so all are included in the bundle by default.

### 2. Minifying the ES Module File (`snap-records.es.js`)

By default, Vite minifies the UMD file but not the ES Module file to preserve tree-shaking capabilities. You can customize this behavior in the build script.

**File Location**: `package.json`

#### Option A: Minify the `.es.js` File

Forces minification of both `snap-records.es.js` and `snap-records.umd.js` using Terser.

```json
// package.json
"scripts": {
    "build:js": "vite build && terser dist/snap-records.es.js --compress --mangle --output dist/snap-records.es.js",
    "build:css": "sass src/scss/SnapRecords.scss dist/snap-records.css --style=compressed --source-map",
    "build": "npm run build:js && npm run build:css"
}
```

#### Option B: Do Not Minify the `.es.js` File (Current)

Preserves Vite’s default behavior, keeping the ES Module file unminified for optimal tree-shaking by the consumer’s bundler.

```json
// package.json
"scripts": {
    "build:js": "vite build",
    "build:css": "sass src/scss/SnapRecords.scss dist/snap-records.css --style=compressed --source-map",
    "build": "npm run build:js && npm run build:css"
}
```

> **When to choose each option?**
>
> - **Minify `.es.js`**: Use only if the ES Module file will be used directly in production without further bundling, requiring the smallest possible file size.
> - **Do Not Minify `.es.js`**: Recommended for most cases, as it allows the consumer’s bundler to perform tree-shaking, removing unused code and producing a more optimized final bundle.

**Current Configuration**: The `package.json` uses `"build": "npm run build:js && npm run build:css"`, with `build:js` running `vite build`, so the `.es.js` file is not minified, aligning with Vite’s default behavior.

### 3. Type Declaration Files (`.d.ts`) Organization

The `vite-plugin-dts` plugin generates TypeScript declaration files, and you can control their structure.

**File Location**: `vite.config.ts`

#### Option A: Single Declaration File (Current)

Bundles all types into a single `index.d.ts` file in the `dist/` folder, providing a clean distribution.

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import dts from 'vite-plugin-dts';

export default defineConfig({
    plugins: [
        dts({
            rollupTypes: true,
            insertTypesEntry: true,
        }),
    ],
    // ...
});
```

**Note**: The `"types"` field in `package.json` is set to `"./dist/index.d.ts"`, matching this configuration.

#### Option B: Declaration Files in a Subfolder

Generates declaration files in a `types/` subfolder, maintaining the source file structure.

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import dts from 'vite-plugin-dts';

export default defineConfig({
    plugins: [
        dts({
            outDir: 'types',
            insertTypesEntry: true,
        }),
    ],
    // ...
});
```

**Note**: Update the `"types"` field in `package.json` to point to the main declaration file, e.g., `"./dist/types/SnapRecords.d.ts"`.

> **When to choose each option?**
>
> - **Single Declaration File**: Preferred for simplicity and ease of use in most projects, as it consolidates all types into one file.
> - **Subfolder Structure**: Useful for complex libraries with multiple entry points or when maintaining the source structure is desired.

**Current Configuration**: The `vite.config.ts` uses `rollupTypes: true` and `insertTypesEntry: true`, producing a single `index.d.ts` file.

### 4. Compiling SCSS Styles

The library includes styles in `src/scss/SnapRecords.scss`, which are compiled to compressed CSS (`dist/snap-records.css`) with source maps for distribution. The CSS supports features like draggable column handles, mobile card layouts, and accessibility-focused styles. This step is automated in the `build:css` script:

```bash
sass src/scss/SnapRecords.scss dist/snap-records.css --style=compressed --source-map
```

The output `snap-records.css` is placed in the `dist/` folder and must be included in the consuming application:

```html
<link rel="stylesheet" href="/path/to/snap-records.css" />
```

### 5. Source Maps

Source maps (`snap-records.es.js.map`, `snap-records.umd.js.map`, `snap-records.css.map`) are generated in `dist/` to aid debugging. In production, enable source maps in browser developer tools to map minified code to the original TypeScript/SCSS sources. This is particularly useful for debugging issues with column resizing, drag-and-drop, or rendering modes.

### 6. Testing Configuration

Unit tests are located in the `tests/` directory and use Jest with JSDOM. The `jest.config.js` file configures Jest to look for tests only in `tests/`, improving performance. The `tests/setupTests.ts` file sets up mocks for `fetch`, `window.matchMedia`, `DataTransfer`, and `DragEvent`. Tests validate features like:

- Column resizing and drag-and-drop interactions.
- List and mobile card rendering modes.
- Accessibility features (e.g., keyboard navigation, ARIA attributes).
- API methods for searching, resetting, and changing languages.
- Efficient format caching with `lru-cache`.

Run tests with:

```bash
npm test
```

Ensure tests pass before building, as they validate critical functionality.

**File Location**: `jest.config.js`, `tests/setupTests.ts`

### 7. TypeScript Configuration

The `tsconfig.json` file defines TypeScript compiler options, ensuring type safety and correct output for declaration files, including types for all features:

```json
// tsconfig.json
{
    "compilerOptions": {
        "target": "ES6",
        "module": "esnext",
        "lib": ["ES6", "DOM", "ES2019"],
        "strict": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "moduleResolution": "node",
        "outDir": "./dist",
        "rootDir": "./src",
        "forceConsistentCasingInFileNames": true,
        "declaration": true,
        "declarationDir": "./dist/types",
        "sourceMap": true,
        "resolveJsonModule": true
    },
    "include": ["src"],
    "exclude": ["node_modules", "dist", "tests"]
}
```

Key settings:

- `"declaration": true` and `"declarationDir": "./dist/types"` ensure type declarations are generated for all features.
- `"resolveJsonModule": true` supports importing JSON translation files.
- `"exclude": ["tests"]` prevents test files from being compiled into the output.

### 8. ESLint and Prettier Configuration

The `eslint.config.js` file enforces code quality, and Prettier ensures consistent formatting. These tools help maintain the codebase, especially with new features:

```javascript
// eslint.config.js
import globals from 'globals';
import tseslint from 'typescript-eslint';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';

export default [
    {
        ignores: ['dist/', 'node_modules/', 'coverage/', '*.log', 'vite.config.ts'],
    },
    {
        languageOptions: {
            ecmaVersion: 'latest',
            sourceType: 'module',
            globals: {
                ...globals.browser,
                ...globals.node,
            },
        },
    },
    ...tseslint.configs.recommended,
    eslintPluginPrettierRecommended,
    {
        rules: {
            'no-console': 'warn',
            '@typescript-eslint/no-explicit-any': 'off',
            '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],
        },
    },
];
```

Run linting and formatting with:

```bash
npm run lint
npm run format
```

## Additional Notes

- **Source Maps**: Enabled in `vite.config.ts` (`sourcemap: true`), aiding debugging in production.
- **Terser Minification**: Configured in `vite.config.ts` to remove `console` and `debugger` statements from the UMD bundle, optimizing file size.
- **Translation Files**: The library uses JSON translation files in the `src/lang/` directory (e.g., `en_US.json`). Ensure these are included in your application’s public folder during deployment to support language switching.
- **Tree-Shaking**: The ES Module build (`snap-records.es.js`) is designed for tree-shaking, allowing modern bundlers to remove unused code, including feature modules.
- **Versioning**: The `package.json` specifies `"version": "1.0.0"`. Update this field for new releases.
- **Accessibility**: The library includes ARIA attributes and keyboard navigation, tested in `SnapRecords.test.ts`. Ensure consuming applications maintain accessibility standards.
- **Performance**: Features like lazy loading, preloading, and efficient format caching with `lru-cache` (controlled by `formatCacheSize`) optimize performance. Test these in real-world scenarios to ensure they meet your needs.

## Support

For issues, feature requests, or questions, please open an issue on the repository or contact the maintainer.